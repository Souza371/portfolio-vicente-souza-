name: ğŸš€ Update Portfolio Automatically

on:
  schedule:
    # Atualiza 2 vezes por dia: 8h e 20h (horÃ¡rio UTC)
    - cron: '0 8,20 * * *'
  push:
    branches: [ main ]
  workflow_dispatch: # Permite executar manualmente

jobs:
  update-portfolio:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: ğŸ“Š Fetch GitHub Stats
      uses: actions/github-script@v7
      with:
        script: |
          // Buscar dados do usuÃ¡rio
          const userResponse = await github.rest.users.getByUsername({
            username: 'Souza371'
          });
          
          // Buscar repositÃ³rios
          const reposResponse = await github.rest.repos.listForUser({
            username: 'Souza371',
            sort: 'updated',
            per_page: 100
          });
          
          const userData = userResponse.data;
          const repos = reposResponse.data;
          
          // Calcular estatÃ­sticas
          const publicRepos = userData.public_repos;
          const totalStars = repos.reduce((sum, repo) => sum + repo.stargazers_count, 0);
          const totalForks = repos.reduce((sum, repo) => sum + repo.forks_count, 0);
          const languages = [...new Set(repos.map(repo => repo.language).filter(Boolean))];
          
          // Criar arquivo JSON com dados atualizados
          const stats = {
            user: {
              login: userData.login,
              name: userData.name,
              bio: userData.bio,
              public_repos: publicRepos,
              followers: userData.followers,
              following: userData.following,
              created_at: userData.created_at,
              updated_at: userData.updated_at
            },
            stats: {
              total_stars: totalStars,
              total_forks: totalForks,
              languages_count: languages.length,
              languages: languages.slice(0, 10)
            },
            repositories: repos.slice(0, 12).map(repo => ({
              name: repo.name,
              description: repo.description,
              html_url: repo.html_url,
              homepage: repo.homepage,
              language: repo.language,
              stargazers_count: repo.stargazers_count,
              forks_count: repo.forks_count,
              updated_at: repo.updated_at,
              topics: repo.topics || []
            })),
            last_updated: new Date().toISOString()
          };
          
          // Salvar no arquivo
          const fs = require('fs');
          fs.writeFileSync('github-data.json', JSON.stringify(stats, null, 2));
          
          console.log('âœ… Dados do GitHub atualizados!');
          console.log(`ğŸ“Š ${publicRepos} repositÃ³rios, ${totalStars} stars, ${languages.length} linguagens`);
    
    - name: ğŸ”„ Update HTML with new data
      run: |
        # Atualizar data de Ãºltima atualizaÃ§Ã£o no README
        sed -i "s/Ãšltima atualizaÃ§Ã£o:.*/Ãšltima atualizaÃ§Ã£o: $(date +'%d\/%m\/%Y %H:%M')/" README.md || true
        
        echo "ğŸ“ Dados atualizados com sucesso a cada 2 horas!"
    
    - name: ğŸ“¤ Commit and Push Changes
      run: |
        git config --local user.email "vicentedesouza762@gmail.com"
        git config --local user.name "Vicente Souza"
        
        # Verificar se hÃ¡ mudanÃ§as
        if git diff --exit-code github-data.json > /dev/null; then
          echo "ğŸ“Š Nenhuma mudanÃ§a nos dados do GitHub"
        else
          git add github-data.json README.md
          git commit -m "ğŸ¤– Auto-update a cada 2h: GitHub data $(date +'%Y-%m-%d %H:%M') - Vicente Souza"
          git push
          echo "âœ… Portfolio atualizado automaticamente a cada 2 horas!"
        fi
    
    - name: ğŸŒ Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      if: github.ref == 'refs/heads/main'
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: .
        
    - name: ğŸ“± Send Notification (opcional)
      if: success()
      run: |
        echo "ğŸ‰ Portfolio atualizado com sucesso a cada 2 horas!"
        echo "ğŸ”— Acesse: https://souza371.github.io/portfolio-vicente-souza/"
        echo "â° PrÃ³xima atualizaÃ§Ã£o em 2 horas!"